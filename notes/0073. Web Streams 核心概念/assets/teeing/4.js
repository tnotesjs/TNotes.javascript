// ----------------------------------------
// ğŸ¤” ä¸ºä»€ä¹ˆä¸ç›´æ¥æ‹·è´ä»æµä¸­æµå‡ºçš„æ•°æ®ï¼Œè€Œæ˜¯æ‹·è´æµï¼Ÿ
// ----------------------------------------

// åŸç†ä¸Šå¯è¡Œï¼Œä½†è¿èƒŒæµå¼å¤„ç†çš„åˆè¡·
// ä½¿ç”¨æµçš„ç›®çš„å¾ˆå¤§ç¨‹åº¦ä¸Šå°±æ˜¯ä¸ºäº†ç¼“è§£å†…å­˜çš„å‹åŠ›
// æµè®©æˆ‘ä»¬èƒ½å¤Ÿåˆ†å—è¯»å–æ•°æ®ï¼Œä»è€Œé¿å…ä¸€æ¬¡æ€§å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¯¼è‡´â€œå†…å­˜çˆ†ç‚¸â€

// âš ï¸ æ–¹æ¡ˆ1. æ‹·è´æ•°æ®
// åŸç†ä¸Šå¯è¡Œï¼Œä½†è¿èƒŒæµå¼å¤„ç†çš„åˆè¡·
const response1 = await fetch('/large-video.mp4') // 1GB è§†é¢‘
const reader = response1.body.getReader()

// å°†æ‰€æœ‰æ•°æ®è¯»å…¥å†…å­˜
const chunks = []
while (true) {
  const { done, value } = await reader.read()
  if (done) break
  chunks.push(value) // é—®é¢˜ï¼šæ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼
}

// ç°åœ¨éœ€è¦æ‹·è´æ•´ä¸ªæ•°æ®
const data1 = new Uint8Array(chunks) // 1GB å†…å­˜
const data2 = new Uint8Array(chunks) // åˆ 1GB å†…å­˜

// æ€»å…±å ç”¨ 2GB+ å†…å­˜ï¼å¯¹äºå¤§æ–‡ä»¶ï¼Œå†…å­˜ä¼šçˆ†æ‰

// âœ… æ–¹æ¡ˆ2. åˆ†æµ
// æµå¼å¤„ç†ï¼Œå†…å­˜å‹å¥½
const response2 = await fetch('/large-video.mp4') // 1GB è§†é¢‘
const [stream1, stream2] = response2.body.tee()

// stream1 å’Œ stream2 ä¼šé€å—è¯»å–æ•°æ®
// åŒä¸€æ—¶åˆ»å†…å­˜ä¸­åªæœ‰å°å—æ•°æ®ï¼ˆæ¯”å¦‚ 64KBï¼‰
// å¤„ç†å®Œç«‹å³é‡Šæ”¾ï¼Œå†…å­˜å ç”¨æå°

// æµè§ˆå™¨å¤„ç†
const reader1 = stream1.getReader()
while (true) {
  const { done, value } = await reader1.read()
  if (done) break
  // value åªæ˜¯å½“å‰çš„ 64KB æ•°æ®å—
  displayVideo(value)
  // æ˜¾ç¤ºå®Œåï¼Œè¿™å—å†…å­˜å°±å¯ä»¥é‡Šæ”¾äº†
}

// ç¼“å­˜å¤„ç†
await cache.put('/video.mp4', new Response(stream2))
// å†…éƒ¨ä¹Ÿæ˜¯é€å—å†™å…¥ç¼“å­˜ï¼Œä¸ä¼šä¸€æ¬¡æ€§å ç”¨ 1GB å†…å­˜
